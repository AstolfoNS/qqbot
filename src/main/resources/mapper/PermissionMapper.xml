<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.timeleafing.qqbot.mapper.PermissionMapper">

    <select id="getPermissionsByUserId" resultType="com.timeleafing.qqbot.model.entity.PermissionEntity">
        SELECT DISTINCT
            p.id,

            p.code,
            p.name,
            p.type,
            p.description,
            p.sort_order,

            p.created_at,
            p.updated_at,
            p.created_by,
            p.updated_by,
            p.remark,

            p.status,
            p.is_deleted,
            p.opt_lock_version
        FROM permissions p
            INNER JOIN role_permissions rp ON p.id = rp.permission_id
            INNER JOIN roles r ON rp.role_id = r.id
            INNER JOIN user_roles ur ON r.id = ur.role_id
        WHERE ur.user_id = #{userId}
          AND p.is_deleted = 0
          AND p.status = 1
          AND rp.is_deleted = 0
          AND r.is_deleted = 0
          AND r.status = 1
          AND ur.is_deleted = 0
        ORDER BY p.sort_order, p.id
    </select>

</mapper>
